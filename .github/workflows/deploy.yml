name: Bedrock Slack Integration ìë™ ë°°í¬

on:
  push:
    branches: [ main, unify ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3

    - name: AWS ìê²©ì¦ëª… ì„¤ì •
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2

    - name: ë¸Œëœì¹˜ë³„ ë°°í¬
      run: |
        BRANCH_NAME=$(echo "${GITHUB_REF#refs/heads/}")
        echo "í˜„ì¬ ë¸Œëœì¹˜: $BRANCH_NAME"
        CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || echo "all")
        echo "ë³€ê²½ëœ íŒŒì¼ë“¤: $CHANGED_FILES"

        if [ "$BRANCH_NAME" = "main" ]; then
          # main ë¸Œëœì¹˜: ê¸°ì¡´ ì „ì²´ ë°°í¬
          # Slack Handler ë°°í¬
          if echo "$CHANGED_FILES" | grep -q "slack-handler/" || [ "$CHANGED_FILES" = "all" ]; then
            if [ -d "slack-handler" ]; then
              echo "slack-handler í´ë” ë³€ê²½ ê°ì§€ - ë°°í¬ ì‹œì‘"
              cd slack-handler
              zip -r ../slack-handler.zip . -x "*.pyc" "__pycache__/*"
              cd ..
              aws lambda update-function-code \
                --function-name FitCloudDMBotHandler \
                --zip-file fileb://slack-handler.zip
              echo "âœ… FitCloudDMBotHandler ë°°í¬ ì™„ë£Œ!"
            fi
          fi
          # Agent1 Actions ë°°í¬
          if echo "$CHANGED_FILES" | grep -q "agent1-actions/" || [ "$CHANGED_FILES" = "all" ]; then
            if [ -d "agent1-actions" ]; then
              echo "agent1-actions í´ë” ë³€ê²½ ê°ì§€ - ë°°í¬ ì‹œì‘"
              cd agent1-actions
              zip -r ../agent1-actions.zip . -x "*.pyc" "__pycache__/*"
              cd ..
              aws lambda update-function-code \
                --function-name fitcloud_action_part1-wpfe6 \
                --zip-file fileb://agent1-actions.zip
              echo "âœ… fitcloud_action_part1-wpfe6 ë°°í¬ ì™„ë£Œ!"
            fi
          fi
          # Agent2 Actions ë°°í¬
          if echo "$CHANGED_FILES" | grep -q "agent2-actions/" || [ "$CHANGED_FILES" = "all" ]; then
            if [ -d "agent2-actions" ]; then
              echo "agent2-actions í´ë” ë³€ê²½ ê°ì§€ - ë°°í¬ ì‹œì‘"
              cd agent2-actions
              zip -r ../agent2-actions.zip . -x "*.pyc" "__pycache__/*"
              cd ..
              aws lambda update-function-code \
                --function-name action_group_quick_start_fcg5f-plzem \
                --zip-file fileb://agent2-actions.zip
              echo "âœ… action_group_quick_start_fcg5f-plzem ë°°í¬ ì™„ë£Œ!"
            fi
          fi
          # Supervisor(Agent0) Actions ë°°í¬
          if echo "$CHANGED_FILES" | grep -q "supervisor/" || [ "$CHANGED_FILES" = "all" ]; then
            if [ -d "supervisor" ]; then
              echo "supervisor í´ë” ë³€ê²½ ê°ì§€ - ë°°í¬ ì‹œì‘"
              cd supervisor
              zip -r ../supervisor.zip . -x "*.pyc" "__pycache__/*"
              cd ..
              aws lambda update-function-code \
                --function-name supervisorAgent0ActionGrp250708 \
                --zip-file fileb://supervisor.zip
              echo "âœ… supervisorAgent0ActionGrp250708 ë°°í¬ ì™„ë£Œ!"
            fi
          fi
        elif [ "$BRANCH_NAME" = "unify" ]; then
          # unify ë¸Œëœì¹˜: agent1-actionsë§Œ ë°°í¬
          if echo "$CHANGED_FILES" | grep -q "agent1-actions/" || [ "$CHANGED_FILES" = "all" ]; then
            if [ -d "agent1-actions" ]; then
              echo "[unify] agent1-actions í´ë” ë³€ê²½ ê°ì§€ - ë°°í¬ ì‹œì‘"
              cd agent1-actions
              zip -r ../agent1-actions.zip . -x "*.pyc" "__pycache__/*"
              cd ..
              aws lambda update-function-code \
                --function-name fitcloud_action_part1-wpfe6 \
                --zip-file fileb://agent1-actions.zip
              echo "âœ… [unify] fitcloud_action_part1-wpfe6 ë°°í¬ ì™„ë£Œ!"
            fi
          fi
        else
          echo "ì´ ë¸Œëœì¹˜ì—ì„œëŠ” ë°°í¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        fi

    - name: ë°°í¬ ì™„ë£Œ
      run: echo "ğŸ‰ ë°°í¬ ì‘ì—… ì™„ë£Œ!"